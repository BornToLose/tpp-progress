var pageData,fakeQuery=function(t){return Array.prototype.slice.call(document.querySelectorAll(t))},$find=function(t,e){return t.map(function(t){return t?Array.prototype.slice.call(t.querySelectorAll(e)):[]})};function getLeft(t){return parseInt(t.style.left.replace("px",""))}function getWidth(t){return t.offsetWidth}function findImage(t){return $find([t],"img").pop().pop()||new Image}function marginTop(t){return parseInt((t.style.marginTop||"0").replace("/(px)|(em)/g",""))||0}var globalPpd=64,groups={},vidWait=$.Deferred(),videos=vidWait.promise(),getTwitchVideos=function(){var t=$(".controls .fa-twitch").removeClass("fa-twitch").addClass("fa-pulse fa-spinner").removeAttr("onclick").attr("title","Loading...").parent();vidWait.resolve([]),t.fadeOut()};function makeGrid(t){var e=document.createElement("canvas");e.height=1,e.width=t/2;var a=e.getContext("2d");return a.strokeStyle="darkgray",a.moveTo(t/2,-1),a.lineTo(t/2,2),a.stroke(),e.toDataURL()}function createCharts(t){QueryString.only&&(t=t.filter(function(e){return 0<QueryString.only.split(",").filter(function(t){return 0<=e.Name.indexOf(t.trim())}).length})),QueryString.run&&(t=t.map(function(t){return t.Runs=t.Runs.filter(function(e){return 0<QueryString.run.split(",").filter(function(t){return 0<=e.RunName.indexOf(t.trim())}).length}),t}).filter(function(t){return 0<t.Runs.length})),(pageData=t.filter(function(t){return 0<t.Runs.filter(function(t){return t.StartTime<Date.now()/1e3}).length})).forEach(createChart),setTimeout(function(){return updatePage()},1)}function createChart(a){var n=document.createElement("div");n.className="progressChart",n.setAttribute("data-label",a.Name),setUniqueId(n,a.Name),n.setAttribute("data-scale",TPP.Scale[a.Scale]);var t=parseInt(QueryString.offset||"0")+(a.Offset||0);t&&n.setAttribute("data-offset",t.toString());var e=fakeQuery(".charts")[0]||document.body;setTimeout(function(){return e.appendChild(n)},1);var r=new Duration(0);a.Runs.filter(function(t){return t.StartTime<Date.now()/1e3}).forEach(function(t){Duration.parse(t.EndDate||t.Duration,t.StartTime).TotalSeconds>Date.now()/1e3-t.StartTime&&(t.Duration=(new Date).toISOString(),t.Ongoing=!0);var e=Duration.parse(t.EndDate||t.Duration,t.StartTime);r.TotalSeconds<e.TotalSeconds&&(r=e),n.appendChild(queueRun(t,a.Scale))});var i=document.createElement("div");i.className="ruler",n.insertBefore(i,n.firstChild);for(var o=r.TotalTime(a.Scale),s=0;s<=o+1;s++){var d=document.createElement("div");i.appendChild(d),d.className="stop",d.setAttribute("data-scale",TPP.Scale[a.Scale])}}function reprocessCharts(t){void 0===t&&(t=pageData),t.forEach(function(t){return t.Runs.filter(function(t){return t.StartTime<Date.now()/1e3}).forEach(function(t){return queueRun(t)})})}function queueRun(e,a){return void 0===a&&(a=TPP.Scale.Days),e.Element=e.Element||document.createElement("div"),e.Hidden=settings.hideUnfinished&&e.Unfinished&&!e.Ongoing,e.Hidden?e.Element.classList.add("hidden"):e.Element.hasAttribute("data-label")?e.Element.classList.remove("hidden"):e.Scraper?Scrape(e).then(function(t){return drawRun(t,e.Element,a)},console.error):setTimeout(function(){return drawRun(e,e.Element,a)},0),e.Element}function drawRun(a,e,n,t){void 0===n&&(n=TPP.Scale.Days),void 0===t&&(t=!0),(e=e||document.createElement("div")).className="run",a.Ongoing&&(e.className+=" ongoing"),a.Class&&(e.className+=" "+a.Class),a.Region&&(e.className+=" "+cleanString(a.Region));var r=Duration.parse(a.Duration,a.StartTime);return a.Duration=r.toString(TPP.Scale.Weeks),e.setAttribute("data-duration",a.Duration),e.setAttribute("data-endtime",Duration.parse(a.EndDate||a.Duration,a.StartTime).toString(TPP.Scale.Weeks)),e.setAttribute("data-start",a.StartTime.toString()),e.setAttribute("data-label",a.RunName+": "+r.toString(n)),e.setAttribute("data-startDate",new Date(a.StartDate).toISOString().replace(/-/g,"/").replace(/T/," ").replace(/:\d+\.\d+/,"").replace(/Z/," UTC")),e.style.backgroundColor=a.ColorPrimary,e.style.backgroundImage=a.BackgroundImage,e.style.borderColor=e.style.color=a.ColorSecondary,setUniqueId(e,a.RunName),a.HostImage&&a.HostName&&e.appendChild(drawHost(a,n)),t&&(a.Events.filter(function(t){return 0<=Duration.parse(t.Time,a.StartTime).TotalSeconds}).sort(function(t,e){return Duration.parse(t.Time,a.StartTime).TotalSeconds-Duration.parse(e.Time,a.StartTime).TotalSeconds}).forEach(function(t){return e.appendChild(drawEvent(t,a,n))}),a.Events.forEach(function(t){return delete t.New}),drawVideos(a,e,n),setTimeout(function(){return updateRun(a,e,n)},9e5),drawConcurrentRuns(a,e,n)),$(e).on("click",function(t){t.shiftKey?($(this).hide(),$(this).siblings(".run:visible").is("*")||$(this).parent().hide()):t.ctrlKey||t.metaKey?console.log(JSON.stringify(a)):t.altKey&&$(this).find(".event").each(function(){$(this).trigger("describe")})}),setTimeout(function(){return scaleRun(e)},0),e}function updateRun(a,n,r){a.Scraper&&a.Ongoing&&(Scrape(a).then(function(t){var e=Duration.parse(a.Duration,a.StartTime).toString(r);console.log("Updating "+a.RunName+" to "+e),n.setAttribute("data-duration",e),n.setAttribute("data-endtime",Duration.parse(a.EndDate||a.Duration,a.StartTime).toString(TPP.Scale.Weeks)),n.setAttribute("data-label",a.RunName+": "+Duration.parse(a.Duration,a.StartTime).toString(r)),a.Events.filter(function(t){return t.New}).forEach(function(t){return n.appendChild(drawEvent(t,a,r))}),scaleRun(n)}),setTimeout(function(){return updateRun(a,n,r)},9e5))}var cleanString=function(t){return t.replace(/[^A-Z0-9-]/gi,"").toLowerCase()};function setUniqueId(t,e){for(var a=e=cleanString(e),n=1;document.getElementById(e);e=a+n++);t.setAttribute("id",e),t.classList.add(a)}function drawHost(t,e){var a=drawEvent({Group:"Hosts",Name:t.HostName,Image:t.HostImage,ImageSource:t.HostImageSource,Time:""},t,e);return a.style.left="0",a}function drawConcurrentRuns(i,e,o){var s,a,d;i.ContainsRunsFrom&&i.ContainsRunsFrom.length&&(s=Duration.parse(i.Duration),a=i.StartTime+s.TotalSeconds,d=new Array,tppData.filter(function(t){return 0<=i.ContainsRunsFrom.indexOf(t.Name)}).map(function(r){return r.Runs.filter(function(t){return i!=t&&i.StartTime<=t.StartTime&&a>t.StartTime}).forEach(function(t){var e=document.createElement("div"),a=Duration.parse(t.StartDate,i.StartTime),n=Duration.parse(t.Duration,t.StartTime);e.setAttribute("data-time",a.toString(TPP.Scale.Weeks)),d.push({time:a.TotalSeconds,div:e}),drawRun(t,e,o,!1),n.TotalSeconds+a.TotalSeconds>=s.TotalSeconds&&(n.TotalSeconds=s.TotalSeconds-a.TotalSeconds,e.setAttribute("data-duration",n.toString(TPP.Scale.Weeks)),e.setAttribute("data-endtime",n.toString(TPP.Scale.Weeks))),n.TotalSeconds+=a.TotalSeconds,e.classList.add("inner"+cleanString(t.RunName)),e.setAttribute("data-label",(r.SingularName||r.Name)+"\n"+t.RunName+"\nStarted: "+a.toString(o)+(t.Ongoing?"":"\nEnded: "+n.toString(o)))})}),d.sort(function(t,e){return t.time-e.time}).forEach(function(t){return e.appendChild(t.div)}))}function drawEvent(e,a,t){delete e.New;var n=e.Group.replace(/[^A-Z0-9-]/gi,"").toLowerCase(),r=document.createElement("div"),i=document.createElement("img");r.classList.add("event"),e.Class&&e.Class.split(" ").forEach(function(t){return r.classList.add(t.replace(/[^A-Z0-9-]/gi,"").toLowerCase())}),"pokemon"!=e.Group.toLowerCase()||e.Image||r.classList.add("pokesprite"),r.classList.contains("pokesprite")&&r.classList.add(e.Name.replace(/[^A-Z0-9-]/gi,"").toLowerCase()||"missingno");var o,s=e.Image||"img/missingno.png";e.ImageSource?(o=document.createElement("a"),r.appendChild(o),o.appendChild(i),o.setAttribute("href",e.ImageSource),o.setAttribute("target","_blank")):r.appendChild(i),r.classList.add(n);var d,u=Duration.parse(e.Time,a.StartTime),l=e.Name;return e.Time&&(l+="\n"+u.toString(t)),e.Estimate&&(l+="\n(estimated)"),e.Attempts&&(l+="\n("+e.Attempts+" Attempt"+(1<e.Attempts?"s":"")+")"),i.src=s,i.alt=l,r.setAttribute("data-label",l),r.setAttribute("data-time",u.toString(TPP.Scale.Weeks)),!1===showGroups[n]&&r.classList.add("hidden"),groups[n]=e.Group,e.Party&&((d=drawHallOfFame(e,a,t)).classList.add("extra"),r.appendChild(d)),$(r).on("describe",function(t){console.log(new Date(1e3*(a.StartTime+u.TotalSeconds)).toISOString()+" ("+u.toString()+") - "+e.Group+": "+e.Name+(e.Estimate?" (Estimated)":""))}),r}function drawHallOfFame(t,e,a){void 0===a&&(a=TPP.Scale.Days);var n=$("<div class='hallOfFameDisplay'>");n.addClass(cleanString(e.RunName)+" "+(e.Class||"")+" "+(e.BaseGame||"")),n.css("background-color",e.ColorPrimary),n.css("border-color",e.ColorSecondary);var r=new Date(1e3*(Duration.parse(t.Time,e.StartTime).TotalSeconds+e.StartTime));n.append($("<h3>").text(t.Name+" - "+r.toLocaleDateString())),n.append($("<h4>").text(Duration.parse(t.Time,e.StartTime).toString(a))),t.Attempts&&n.append($("<h5>").text(t.Attempts+" Attempts")),n.append($("<img>").attr("src",t.Image));var o=$("<tr>").appendTo($("<table>").appendTo(n)),i=$("<div class='entry host'>").appendTo($("<td>").appendTo(o)),s=$("<img>").attr("src",e.HostImage).attr("alt",e.HostName).attr("title",e.HostName);e.HostImageSource&&(s=$("<a>").attr("href",e.HostImageSource).append(s)),i.append(s);var d=$('<div class="info">').append($('<div class="name">').text(e.HostName)).appendTo(i);t.IDNo&&d.append($('<div data-entry="IDNo">').text(t.IDNo)),t.Party.forEach(function(t){var e=(t.Nickname||t.Pokemon).replace(/\s/g,"&nbsp;"),a=$("<div class='entry'>").addClass((t.Gender||"").toLowerCase());a.append($("<span class='level'>").text(t.Level)),a.append($("<div class='pokesprite'><img src='img/missingno.png'/></div>").addClass(cleanString(t.Pokemon)).addClass(t.Shiny?"shiny":"").addClass((t.Gender||"").toLowerCase()).addClass(t.Class).addClass(cleanString(t.Form||"")).attr("title",t.Pokemon));var n,r,i=$("<div class='info'>").append($("<div class='name'>").html(e)).appendTo(a);t.Number&&(r=("000"+(n=t.Number.toString())).substring(n.length),i.append($("<div data-entry='"+r+"'>").text(t.Pokemon))),t.Met&&i.append($("<div data-entry='Met'>").text(t.Met)),t.Type1&&i.append($("<div data-entry='Type 1'>").text(t.Type1)),t.Type2&&i.append($("<div data-entry='Type 2'>").text(t.Type2)),t.OT&&i.append($("<div data-entry='OT'>").text(t.OT)),t.IDNo&&i.append($("<div data-entry='IDNo'>").text(t.IDNo)),o.append($("<td>").append(a))});for(var u=t.Party.length;u<6;u++)$("<div class='entry'>").appendTo($("<td>").appendTo(o));return n.get(0)}function applyScale(n){globalPpd=n=Math.pow(2,Math.floor(Math.log(n||globalPpd||64)/Math.log(2))),fakeQuery(".progressChart").forEach(function(t){t.style.backgroundImage='url("'+makeGrid(n)+'")',$(t).find(".run:not(.hidden)").is("*")?t.classList.remove("hidden"):t.classList.add("hidden")}),$find(fakeQuery(".progressChart .ruler"),".stop").forEach(function(t){return t.forEach(function(t,e){var a=parseFloat($(t).parents(".progressChart").data("offset")||"0");t.style.left=(e+a)*n+"px"})}),fakeQuery(".progressChart > .run").forEach(function(t){return scaleRun(t,n)})}function scaleRun(e,n){var r,i,o,t,a,s,d;$(e).is(".hidden")||($(e).parents(".hidden").removeClass("hidden"),n=n||globalPpd,r=TPP.Scale[e.parentElement.getAttribute("data-scale")]||TPP.Scale[e.parentElement.parentElement.getAttribute("data-scale")]||0,i=settings.postgame?"data-endtime":"data-duration",o=Duration.parse(e.getAttribute(i)),e.getAttribute(i)&&(e.style.width=o.TotalTime(r)*n+"px"),t=$find([e],".run").pop(),a=$find([e],".event").pop().filter(function(t){return!t.classList.contains("hidden")&&t.parentElement==e}),s=$find([e],".videos a").pop(),[].concat(a).concat(t).concat(s).forEach(function(t){var e;t.getAttribute("data-time")&&(e=Duration.parse(t.getAttribute("data-time")),t.style.left=e.TotalTime(r)*n+"px",t.style.display=!settings.postgame&&!$(t).parents(".run").is(".ongoing")&&e.TotalSeconds>o.TotalSeconds?"none":"block"),t.getAttribute(i)&&(t.style.width=Duration.parse(t.getAttribute(i)).TotalTime(r)*n+"px");var a=findImage(t);a&&(a.style.marginTop=t.style.marginTop="0")}),staggerStackedRuns(t,e.offsetHeight),settings.explode&&staggerStackedEvents(a.filter(function(t){return"none"!=t.style.display}),e.offsetHeight),d=parseFloat($(e).parents(".progressChart").data("offset")||"0"),e.style.marginLeft=d*n+"px",$(e).find(".hosts").first().css("margin-left",-d*n+"px"))}function staggerStackedRuns(a,t){var s=-(t/2-2);a.forEach(function(n,t){var r=s*=-1,i=Duration.parse(n.getAttribute("data-time")).TotalSeconds,o=i+Duration.parse(n.getAttribute("data-duration")).TotalSeconds;function e(t){var e=Duration.parse(t.getAttribute("data-time")).TotalSeconds,a=e+Duration.parse(t.getAttribute("data-duration")).TotalSeconds;(i<=e&&e<o||i<a&&a<=o)&&(0<r&&(t.style.marginTop=r+"px"),r<0&&(n.style.marginTop=-r+"px"),t.style.height=n.style.height=Math.abs(r)+"px")}a[t-1]&&e(a[t-1]),a[t+1]&&e(a[t+1])})}function staggerStackedEvents(t,a){var l=.1;[t.filter(function(t){return t.className.indexOf("pokemon")<0&&t.className.indexOf("halloffame")<0}),t.filter(function(t){return 0<=t.className.indexOf("pokemon")})].forEach(function(n){function u(t,e){return e?25:getWidth(t)||a}n.forEach(function(t,e){var r,i,o,s,d=l*=-1;function a(t){var e=findImage(t),a=u(e,r),n=getLeft(t)-a/2;s<n+a&&n<s+o&&(e.style.marginTop=marginTop(e)-(n+a-s)*d+"px",i.style.marginTop=marginTop(i)+(n+a-s)*d+"px",i.style.zIndex=0<d?"1":"0")}0!=e&&(r=0<=t.className.indexOf("pokemon"),i=findImage(t),o=u(i,r),s=getLeft(t)-o/2,1<e&&n[e-1]&&a(n[e-1]),n[e+1]&&a(n[e+1]))})}),findImage(t[0]).style.marginTop="0",$(t[0]).parents(".run").is(".ongoing")||(findImage(t[t.length-1]).style.marginTop="0")}var pageUpdateTimeout=null;function updatePage(t){void 0===t&&(t=globalPpd),pageUpdateTimeout&&clearTimeout(pageUpdateTimeout),pageUpdateTimeout=setTimeout(function(){setTimeout(function(){return applyScale(t)},0);var e=fakeQuery(".groups input").map(function(t){return t.id.split("-").pop()})||[],r=fakeQuery(".groups ul").pop();Object.keys(groups).filter(function(t){return e.indexOf(t)<0}).forEach(function(t){var e=document.createElement("li"),a=document.createElement("input"),n=document.createElement("label");e.appendChild(a),e.appendChild(n),r.appendChild(e),a.type="checkbox",n.htmlFor=a.id="group-"+t,a.checked=!1!==showGroups[t],n.innerText=groups[t],a.onchange=function(){return toggleGroup(a)}})},0)}function drawVideos(i,t,o,e){void 0===e&&(e=videos);var a=$('<div class="videos">').appendTo(t);e.then(function(){var r=new Duration(i.Duration);$("<a target='_blank'>").addClass("twitch").appendTo(a).mousemove(function(t){var e=Math.abs(t.pageX-$(this).offset().left)/$(this).width(),a=new Duration(0);a.TotalSeconds=e*r.TotalSeconds;var n=new Date(1e3*(i.StartTime+a.TotalSeconds));$(this).attr("href","https://tpp.chat/jump/vod/"+n.toISOString()),$(this).find(".playhead").css("left",e*$(this).width()).attr("data-label",a.toString(o)+"\n"+n.toLocaleString())}).click(function(t){return t.stopPropagation()}).append($("<div class='playhead'>")).attr("data-time",new Duration(0).toString()).attr("data-duration",r.toString()),$(t).addClass("hasVideos"),$("#group-videos").is("*")||$("<li>").append($('<input type="checkbox" id="group-videos" checked>').change(function(){$("div.videos").toggleClass("hidden",$(this).val())})).append($('<label for="group-videos">').text("Videos")).appendTo($("li.groups ul")),setTimeout(function(){return scaleRun(t)},0)})}var HeatMap=function(a,n){this.Color=function(t){var e=(t-a)/(n-a)*Math.PI;return"rgb("+Math.sin(e).toFixed(0)+",0,"+Math.cos(e).toFixed(0)+")"}};function drawRedditLive(t,e,a){$('<div class="videos">').appendTo(e),new Duration(t.Duration).TotalSeconds}var zoomIn=function(){return applyScale(2*globalPpd)},zoomOut=function(){return applyScale(globalPpd/2)},defaultSettings={explode:!0,hideUnfinished:!0},settings=JSON.parse(localStorage.getItem("settings")||"{}");Object.keys(defaultSettings).forEach(function(t){return settings[t]="boolean"==typeof settings[t]?settings[t]:defaultSettings[t]});var showGroups=JSON.parse(localStorage.getItem("showGroups")||"{}");function toggleSetting(t){var e=t.id;settings[e]=t.checked,localStorage.setItem("settings",JSON.stringify(settings)),"hideUnfinished"==e&&reprocessCharts(),updatePage()}function toggleGroup(t){var e=t.id.split("-").pop(),a=t.checked;showGroups[e]=a,localStorage.setItem("showGroups",JSON.stringify(showGroups)),$("."+e.replace(/[^A-Z0-9-]/gi,"")).toggleClass("hidden",!a),updatePage()}window.addEventListener("load",function(){fakeQuery(".settings input").forEach(function(t){return t.checked=settings[t.id]}),fakeQuery(".groups input").forEach(function(t){return t.checked=!1!==showGroups[t.id.split("-").pop()]}),updatePage()});