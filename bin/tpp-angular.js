var tppNg=angular.module("tpp-progress",[]),tppData=tppData;function scrapeRun(u,t){t=t.replace(/\bsrc\=/gi,"crs=");var e=$(t).find(".last-update");u.Scraper.parts=u.Scraper.parts||["Badge","Elite Four"];var r=$(t).find(u.Scraper.parts.map(function(t){return"h3 strong:contains("+t+")"}).join(","));u.Scraper.runtime&&e.is("*")&&(u.Duration=(e.text().split(":").pop()||"0d").trim(),Duration.canParse(u.Duration)||(u.Duration=(new Date).toISOString()));var a,c={};u.Events.forEach(function(t){return c[t.Name+t.Time]=t}),r.each(function(t,e){var i=$(e).parent().next(".table-pokemon"),o=$(e).text();i.find("th").each(function(t,e){var r=$(e).text(),n=i.find("tr td:nth-child("+(t+1)+")"),a=$(n[1]).text().trim();n.find("img").is(".greyed-out")||c[r+a]||u.Events.push({Group:o,Image:(n.find("img").attr("crs")||"").replace(/^\//,u.Scraper.url+"/"),Name:r,Time:a,Attempts:parseInt(n.find("strong").text()||"0"),New:!0})})}),u.Scraper.hostname&&(u.HostName=$(t).find('td.text-left:contains("Trainer Name")').next("td.text-right").text()||u.HostName),u.Scraper.pokemon&&(a={},u.Events.filter(function(t){return"Pokemon"==t.Group}).forEach(function(t){return a[t.Name]=t}),$(t).find(".history-obtained").each(function(){var t,e=$(this),r=e.find("img");t=r.is("*")?r.attr("title")||"":e.attr("title").split("(").shift().trim();var n=e.text().replace(/[()]/g,"").trim();!a[t]&&Duration.canParse(n)&&(a[t]={Name:t,Time:n,Group:"Pokemon",New:!0})}),Object.keys(a).forEach(function(t){return u.Events.push(a[t])}))}tppNg.controller("credits",function(t){t.extraCredits=[{Name:"TheSwordUser"},{Name:"UDie2day"},{Name:"AsterJ"},{Name:"Rabbeseking"},{Name:"Tiesoul"},{Name:"valence_d",User:"Persona_Alio"},{Name:"ChezMere"},{Name:"T-chan"},{Name:"yoshord"},{Name:"Sauzels",User:"Sauzels"}],t.live=0<tppData.filter(function(t){return 0<t.Runs.filter(function(t){return t.Scraper&&!0}).length}).length?"Live":"Most"}),tppNg.controller("progressCharts",function(n,a){tppData.forEach(function(t){return t.Runs.forEach(function(r,t){var e,n;r.StartTime=r.StartTime||(r.StartDate?Math.floor(Date.parse(r.StartDate)/1e3):0),r.Scraper&&((e=function(){return a.get("https://crossorigin.me/"+r.Scraper.url).then(function(t){return scrapeRun(r,t.data)})})(),r.Duration="0d",setInterval(e,9e5)),r.CopyEvents&&(n=[],tppData.forEach(function(t){return t.Runs.filter(function(t){return 0<=r.CopyEvents.indexOf(t.RunName)}).forEach(function(t){return n=n.concat.apply(n,t.Events)})}),n.forEach(function(e){return r.Events.filter(function(t){return t.Name==e.Name&&t.Time==e.Time}).length?"":r.Events.push(e)}))})}),n.tppData=tppData.filter(function(t){return 0<t.Runs.filter(function(t){return t.StartTime<Date.now()/1e3}).length}),n.cleanText=function(t){return t.replace(/♀/g,"F").replace(/♂/g,"M").replace(/\?/g,"-q").replace(/[^A-Z0-9-]/gi,"").toLowerCase()},n.duration=function(t,e,r){return void 0===e&&(e=TPP.Scale.Weeks),Duration.parse(t,r).toString(e)},n.time=function(t,e,r){return void 0===e&&(e=TPP.Scale.Days),Duration.parse(t,r).TotalTime(e)},n.width=function(t,e,r){return void 0===e&&(e=TPP.Scale.Days),n.time(t,e,r)*n.ppd},n.ppd=64,n.concurrentRuns=function(a,i){if(void 0===i&&(i=TPP.Scale.Days),!a.ContainsRunsFrom)return[];var t=Duration.parse(a.Duration),e=a.StartTime+t.TotalSeconds;return tppData.filter(function(t){return 0<=a.ContainsRunsFrom.indexOf(t.Name)}).map(function(n){return n.Runs.filter(function(t){return a.StartTime<t.StartTime&&e>t.StartTime}).map(function(t){var e=Duration.parse(t.StartDate,a.StartTime),r=Duration.parse(t.Duration,t.StartTime);return t.Label=(n.SingularName||n.Name)+"\n"+t.RunName+"\nStarted: "+e.toString(i)+(t.Ongoing?"":"\nEnded: "+r.toString(i)),t})})},n.steps=function(t){var r=new Duration(0);t.Runs.filter(function(t){return t.StartTime<Date.now()/1e3}).forEach(function(t){var e=Duration.parse(t.EndDate||t.Duration,t.StartTime);r.TotalSeconds<e.TotalSeconds&&(r=e)});for(var e=r.TotalTime(t.Scale),n=[],a=0;a<=e+1;n.push(a++));return n},n.makeGrid=function(t){void 0===t&&(t=n.ppd);var e=document.createElement("canvas");e.height=1,e.width=t/2;var r=e.getContext("2d");return r.strokeStyle="darkgray",r.moveTo(t/2,-1),r.lineTo(t/2,2),r.stroke(),e.toDataURL()},n.scale=function(t){return TPP.Scale[t]},n.zoomIn=function(){return n.ppd*=2},n.zoomOut=function(){return n.ppd/=2}});